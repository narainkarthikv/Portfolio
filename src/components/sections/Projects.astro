---
import Section from "../Section.astro";
import { Icon } from "astro-icon/components";

import { projects } from "@cv";
---

<Section className={Astro.props.className}>
  <div class="projects-coverflow print:flex print:flex-col">
    <div class="flex items-center justify-between">
      <h3 data-ccursor="lift" class="relative flex w-max items-center gap-3 pb-4 text-3xl print:gap-1 print:pb-0 print:text-xl sm:hover:text-skin-hue">
        Projects
      </h3>
      <div class="hidden md:inline-flex items-center gap-2 pb-4">
        <button
          type="button"
          data-projects-prev
          class="inline-flex items-center justify-center size-10 rounded-full bg-skin-button-muted/60 ring-1 ring-white/20 dark:ring-white/10 hover:ring-2 hover:ring-skin-hue/60 transition"
          aria-label="View previous project"
        >
          <Icon name="mdi:arrow-left" class="size-5" />
        </button>
        <button
          type="button"
          data-projects-next
          class="inline-flex items-center justify-center size-10 rounded-full bg-skin-button-muted/60 ring-1 ring-white/20 dark:ring-white/10 hover:ring-2 hover:ring-skin-hue/60 transition"
          aria-label="View next project"
        >
          <Icon name="mdi:arrow-right" class="size-5" />
        </button>
      </div>
    </div>

    <div class="projects-track flex flex-col gap-3 md:relative md:h-[430px] md:items-center md:justify-center md:overflow-hidden" style={`--stack-count: ${projects?.length ?? 0};`}>
      {
        projects && projects.map(
          ({ url, description, highlights, name, isActive, github, stack, caseStudy }, index) => {
            const stackEntries = stack ? Object.entries(stack) : [];
            const experienceEntries = caseStudy?.experience
              ? Array.from(
                caseStudy.experience.matchAll(/(DX|UX)\s*:\s*([\s\S]*?)(?=(?:DX|UX)\s*:|$)/gi),
              ).map(([, key, value]) => ({
                key: key.toUpperCase(),
                value: value.trim(),
              }))
              : [];
            const dxNote = experienceEntries.find(({ key }) => key === "DX")?.value ?? "";
            const uxNote = experienceEntries.find(({ key }) => key === "UX")?.value ?? "";
            const fallbackExperience = !dxNote && !uxNote ? (caseStudy?.experience?.trim() ?? "") : "";
            const maxMobileStack = 3;
            const maxDesktopStack = 6;
            const mobileVisibleStack = stackEntries.slice(0, maxMobileStack);
            const desktopExtraStack = stackEntries.slice(maxMobileStack, maxDesktopStack);
            const mobileOverflowCount = Math.max(0, stackEntries.length - maxMobileStack);
            const desktopOverflowCount = Math.max(0, stackEntries.length - maxDesktopStack);
            const maxDescriptionWords = 22;
            const descriptionWords = description.split(" ");
            const shortDescription = descriptionWords.length > maxDescriptionWords
              ? `${descriptionWords.slice(0, maxDescriptionWords).join(" ")}...`
              : description;
            const maxMobileDescriptionChars = 60;
            const mobileDescription = description.length > maxMobileDescriptionChars
              ? `${description.slice(0, maxMobileDescriptionChars).trimEnd()}...`
              : description;
            return (
              <div
                role="contentinfo"
                class="project-card group relative flex min-h-80 flex-col overflow-hidden rounded-xl border border-white/10 bg-skin-fill/95 shadow-[0_20px_50px_-30px_rgba(0,0,0,0.6)] transition-all duration-300 ease-in-out sm:hover:-translate-y-1 sm:hover:shadow-[0_30px_70px_-40px_rgba(0,0,0,0.7)]"
                style={`--stack-index: ${index};`}
              >
                <div class="project-card-glow" aria-hidden="true"></div>
                <div class="project-card-shell">
                  <div class="project-card-face project-card-front">
                    <div class="project-card-header">
                      <div class="project-card-title">
                        <span class="project-icon">
                          <Icon data-ccursor="lift" name="mdi:folder-outline" class="size-4" />
                        </span>
                        {isActive ? (
                          <a
                            class="group flex items-center gap-[6px] text-lg font-semibold tracking-tight decoration-dotted underline-offset-[5px] hover:text-skin-hue hover:underline transition-all sm:hover:cursor-default"
                            href={url}
                            title={`${name}`}
                            target="_blank"
                          >
                            {name}
                            <span class="text-skin-hue transition ease-linear group-hover:-translate-y-0.5 group-hover:translate-x-0.5">
                              <Icon name="ri:arrow-up-line" class="rotate-45" />
                            </span>
                          </a>
                        ) : (
                          <span class="text-lg">{name}</span>
                        )}
                      </div>

                      <div class="project-card-actions">
                        {github && (
                          <a
                            data-ccursor="lift"
                            href={github}
                            title={`View ${name} in GitHub`}
                            aria-label={`View ${name} in GitHub`}
                            target="_blank"
                            rel="noopener"
                            class="project-github"
                          >
                            <Icon name="mdi:github" width={24} height={24} />
                          </a>
                        )}
                        {caseStudy && (
                          <button
                            type="button"
                            data-project-spin
                            aria-label={`Spin ${name} case study`}
                            class="project-case-button hidden sm:inline-flex"
                            data-ccursor="lift"
                          >
                            <Icon name="mdi:book-open-variant" width={18} height={18} />
                          </button>
                        )}
                      </div>
                    </div>

                    <p data-ccursor="noPadding" class='relative z-10 py-3 text-sm leading-relaxed text-skin-base sm:hidden'>
                      {mobileDescription}
                    </p>
                    <p data-ccursor="noPadding" class='relative z-10 py-3 text-sm leading-relaxed text-skin-base hidden sm:block'>
                      {shortDescription}
                    </p>
                    <ul class='z-10 mt-1 text-sm'>
                      {highlights.map((highlight) => {
                        return <li data-ccursor class="w-max">{highlight}</li>;
                      })}
                    </ul>

                    <ul class="flex print:hidden flex-wrap gap-2 mt-4" aria-label="Technologies used">
                      {mobileVisibleStack.map(([label, icon]) => (
                        <li data-ccursor="lift" class="project-chip flex gap-1.5 items-center border-skin-hue/30 text-skin-base print:p-0 print:bg-transparent print:text-zinc-800 border-solid print:border-none border rounded-full px-2.5 py-1 text-xs bg-skin-button-muted/70 hover:bg-skin-button-muted/90 hover:border-skin-hue/60 transition-all duration-200 ring-1 ring-inset ring-white/10 dark:ring-white/5 group/stack">
                          {icon &&
                            <span class="flex gap-1">
                            <Icon name={icon} width={16} height={16} class="text-skin-hue" /> <span class="project-chip-label transition-all duration-200">{label}</span>
                            </span>
                          }
                        </li>
                      ))}
                      {desktopExtraStack.map(([label, icon]) => (
                        <li data-ccursor="lift" class="project-chip hidden sm:flex gap-1.5 items-center border-skin-hue/30 text-skin-base print:p-0 print:bg-transparent print:text-zinc-800 border-solid print:border-none border rounded-full px-2.5 py-1 text-xs bg-skin-button-muted/70 hover:bg-skin-button-muted/90 hover:border-skin-hue/60 transition-all duration-200 ring-1 ring-inset ring-white/10 dark:ring-white/5 group/stack">
                          {icon &&
                            <span class="flex gap-1">
                            <Icon name={icon} width={16} height={16} class="text-skin-hue" /> <span class="project-chip-label transition-all duration-200">{label}</span>
                            </span>
                          }
                        </li>
                      ))}
                      {mobileOverflowCount > 0 && (
                        <li class="project-chip flex sm:hidden items-center border-skin-hue/30 text-skin-base border-solid border rounded-full px-2.5 py-1 text-xs bg-skin-button-muted/70 hover:bg-skin-button-muted/90 hover:border-skin-hue/60 transition-all duration-200 ring-1 ring-inset ring-white/10 dark:ring-white/5">
                          +{mobileOverflowCount} more
                        </li>
                      )}
                      {desktopOverflowCount > 0 && (
                        <li class="project-chip hidden sm:flex items-center border-skin-hue/30 text-skin-base border-solid border rounded-full px-2.5 py-1 text-xs bg-skin-button-muted/70 hover:bg-skin-button-muted/90 hover:border-skin-hue/60 transition-all duration-200 ring-1 ring-inset ring-white/10 dark:ring-white/5">
                          +{desktopOverflowCount} more
                        </li>
                      )}
                    </ul>
                  </div>

                  {caseStudy && (
                    <div class="project-card-face project-card-back">
                      <div class="project-card-header">
                        <div class="project-card-title">
                          <span class="project-icon">
                            <Icon data-ccursor="lift" name="mdi:folder-outline" class="size-4" />
                          </span>
                          <span class="text-lg font-semibold">{name} Case Study</span>
                        </div>
                        <div class="project-card-actions">
                          {github && (
                            <a
                              data-ccursor="lift"
                              href={github}
                              title={`View ${name} in GitHub`}
                              aria-label={`View ${name} in GitHub`}
                              target="_blank"
                              rel="noopener"
                              class="project-github"
                            >
                              <Icon name="mdi:github" width={24} height={24} />
                            </a>
                          )}
                          <button
                            type="button"
                            data-project-spin
                            aria-label={`Return from ${name} case study`}
                            class="project-case-button hidden sm:inline-flex"
                            data-ccursor="lift"
                          >
                            <Icon name="mdi:book-open-variant" width={18} height={18} />
                          </button>
                        </div>
                      </div>
                      <div class="project-case-grid">
                        <div class="project-case-item">
                          <h4>Trade-offs</h4>
                          <ul>
                            {caseStudy.tradeoffs.map((item) => (
                              <li>{item}</li>
                            ))}
                          </ul>
                        </div>
                        <div class="project-case-item">
                          <h4>Technical Needs</h4>
                          <ul>
                            {caseStudy.technicalNeeds.map((item) => (
                              <li>{item}</li>
                            ))}
                          </ul>
                        </div>
                        <div class="project-case-item">
                          <h4>UX</h4>
                          <p>{uxNote || fallbackExperience || "No UX notes provided."}</p>
                        </div>
                        <div class="project-case-item">
                          <h4>DX</h4>
                          <p>{dxNote || "No DX notes provided."}</p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          },
        )
      }
    </div>
  </div>
</Section>
<script>
  import { Fancybox } from "@fancyapps/ui";
  Fancybox.bind('[data-fancybox="projects"]', { hideScrollbar: false });

  const projectsRoot = document.querySelector(".projects-coverflow");
  if (projectsRoot) {
    const cards = Array.from(
      projectsRoot.querySelectorAll<HTMLElement>(".project-card")
    );
    const prevButton = projectsRoot.querySelector("[data-projects-prev]");
    const nextButton = projectsRoot.querySelector("[data-projects-next]");
    let activeIndex = Math.floor(cards.length / 2);

    const applyCoverflow = () => {
      const isDesktop = window.matchMedia("(min-width: 768px)").matches;
      const total = cards.length;
      const half = Math.floor(total / 2);
      cards.forEach((card, index) => {
        if (!isDesktop) {
          card.style.transform = "";
          card.style.opacity = "";
          card.style.zIndex = "";
          card.style.filter = "";
          card.style.pointerEvents = "";
          card.classList.toggle("is-active", index === activeIndex);
          return;
        }

        let offset = index - activeIndex;
        if (total > 0) {
          offset = ((offset + total + half) % total) - half;
        }
        const absOffset = Math.abs(offset);
        const translateX = offset * 220;
        const scale = 1 - Math.min(absOffset * 0.12, 0.36);
        const rotateY = offset * -16;
        const maxVisible = Math.max(2, Math.min(3, half));
        const opacity = absOffset > maxVisible ? 0 : 1 - absOffset * 0.15;

        card.style.transform = `translate(-50%, -50%) translateX(${translateX}px) scale(${scale}) rotateY(${rotateY}deg)`;
        card.style.zIndex = String(10 - absOffset);
        card.style.opacity = String(opacity);
        card.style.filter = absOffset === 0 ? "none" : "saturate(0.85)";
        card.style.pointerEvents = absOffset === 0 ? "auto" : "none";
        card.classList.toggle("is-active", absOffset === 0);
      });
    };

    const clampIndex = (index: number) => {
      if (cards.length === 0) return 0;
      if (index < 0) return cards.length - 1;
      if (index >= cards.length) return 0;
      return index;
    };

    const setActiveIndex = (index: number) => {
      activeIndex = clampIndex(index);
      applyCoverflow();
    };

    prevButton?.addEventListener("click", () => setActiveIndex(activeIndex - 1));
    nextButton?.addEventListener("click", () => setActiveIndex(activeIndex + 1));

    cards.forEach((card, index) => {
      card.addEventListener("click", () => {
        const isDesktop = window.matchMedia("(min-width: 768px)").matches;
        if (isDesktop) {
          setActiveIndex(index);
        }
      });
    });

    projectsRoot.querySelectorAll<HTMLButtonElement>("[data-project-spin]").forEach((button) => {
      button.addEventListener("click", (event) => {
        event.stopPropagation();
        const card = (button as HTMLElement).closest<HTMLElement>(".project-card");
        if (!card) return;
        card.classList.toggle("is-flipped");
      });
    });

    window.addEventListener("resize", applyCoverflow);
    applyCoverflow();
  }
</script>

<style>
  ul {
    @apply ml-4 list-disc space-y-1;
    li {
      @apply text-skin-muted marker:text-skin-hue;
    }
  }

  footer {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    font-size: 0.6rem;
  }

  footer span {
    border-radius: 6px;
    background: #eee;
    color: #444;
    font-size: 0.6rem;
    font-weight: 500;
    padding: 0.2rem 0.6rem;
  }

  .projects-track {
    perspective: 1200px;
  }

  .project-card {
    position: relative;
  }

  .project-card-shell {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    transform-style: preserve-3d;
    will-change: transform;
    transition: transform 1200ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  .project-card.is-flipped .project-card-shell {
    transform: rotateY(180deg) scale(0.995);
  }

  .project-card-face {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
    backface-visibility: hidden;
    padding: 20px;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04);
  }

  .project-card-front {
    z-index: 2;
  }

  .project-card-back {
    transform: rotateY(180deg);
    background: rgba(10, 14, 24, 0.45);
    border-radius: 12px;
  }

  .project-card::before {
    content: "";
    position: absolute;
    inset: -20px;
    border-radius: 24px;
    background: radial-gradient(50% 40% at 50% 15%, rgba(var(--color), 0.12), transparent 70%);
    opacity: 0;
    transition: opacity 700ms cubic-bezier(0.16, 1, 0.3, 1);
    pointer-events: none;
  }

  .project-card.is-flipped::before {
    opacity: 1;
  }

  @media (prefers-reduced-motion: reduce) {
    .project-card-shell {
      transition: none;
    }
  }

  .project-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(130deg, rgba(255, 255, 255, 0.05), transparent 60%);
    pointer-events: none;
  }

  .project-card-glow {
    position: absolute;
    inset: 0;
    background: radial-gradient(120% 120% at 0% 0%, rgba(84, 137, 255, 0.25), transparent 45%);
    opacity: 0.6;
    pointer-events: none;
  }

  .project-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.08);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  }

  .project-github {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.06);
    opacity: 0.8;
    transition: all 200ms ease;
  }

  .project-github:hover {
    opacity: 1;
    transform: translateY(-1px);
    color: rgb(var(--color));
    background: rgba(var(--color), 0.18);
    box-shadow: 0 10px 30px -18px rgba(0, 0, 0, 0.6);
  }

  .project-case-button {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    height: 36px;
    padding: 0 10px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.08);
    color: inherit;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    transition: all 200ms ease;
  }

  .project-case-button:hover {
    transform: translateY(-1px);
    color: rgb(var(--color));
    background: rgba(var(--color), 0.18);
    box-shadow: 0 10px 30px -18px rgba(0, 0, 0, 0.6);
  }

  .project-case-study {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  .project-case-label {
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(var(--color-text-muted), 0.9);
  }

  .project-case-grid {
    margin-top: 8px;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }

  .project-case-item {
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.02);
    padding: 10px;
  }

  .project-case-grid h4 {
    font-size: 0.75rem;
    font-weight: 600;
    color: rgba(var(--color-text-base), 0.9);
    margin-bottom: 4px;
  }

  .project-case-grid p,
  .project-case-grid li {
    font-size: 0.78rem;
    line-height: 1.4;
    color: rgba(var(--color-text-muted), 0.95);
  }

  .project-chip-label {
    color: rgb(var(--color));
    font-weight: 500;
  }

  .project-card-actions {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .project-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }

  .project-card-title {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    min-width: 0;
  }

  .project-card-title a,
  .project-card-title span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media (max-width: 767px) {
    .projects-track {
      gap: 24px;
      padding-bottom: 0;
    }

    .project-case-button {
      display: none;
    }

    .project-card {
      position: relative;
      top: auto;
      transform: none;
    }

    .project-card::after {
      opacity: 0.35;
    }
  }

  @media (min-width: 768px) {
    .project-card {
      position: absolute;
      left: 50%;
      top: 50%;
      width: min(540px, 70vw);
      transform-style: preserve-3d;
      transition: transform 400ms ease, opacity 300ms ease;
    }
  }
</style>
